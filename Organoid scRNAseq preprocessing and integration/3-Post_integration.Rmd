---
title: "R Notebook"
output: html_notebook
---

```{r}
# Set up temporary directory and memory limits
library(unixtools)
set.tempdir("/datastore3/Dom/temporary/")
ulimit::memory_limit(150000)

# Load required R packages for single-cell analysis
library(ggplot2)
library(harmony)
library(Seurat)
library(patchwork)
library(clustree)
library(SeuratWrappers)
library(Nebulosa)
#library(cellhashR)  # Commented out
#library(dsb)  # Commented out
library(dplyr)
#library(DoubletFinder)  # Commented out
library(STACAS)
library(miloR)

# Load custom functions
source("/datastore/Dom/commonFunctions.R")
```

# after scanvy integration

```{r}
library(Seurat)
library(Matrix)

# Read sparse matrix, features, and barcodes
counts <- readMM("/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.ST.ihn.scanpy_counts+SNPs.mtx") # Transpose back to cells x genes
features <- read.delim("/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.ST.ihn.scanpy_features+SNPs.tsv", header = FALSE, row.names = 1)
barcodes <- read.delim("/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.ST.ihn.scanpy_barcodes+SNPs.tsv", header = FALSE, row.names = 1)

# Check dimensions of imported data
nrow(features)
nrow(barcodes)

# Assign row/column names to the sparse matrix
rownames(counts) <- rownames(features)
colnames(counts) <- rownames(barcodes)

# Create Seurat object from the imported data
Macro.scanpy <- CreateSeuratObject(counts = counts)
```

```{r}
Macro.scanpy
```

```{r}
# Read UMAP coordinates
umap_coords <- read.csv("/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.ST.ihn.scanpy_umap_coordinates+SNPs.csv", row.names = 1)
umap_coords

# Add UMAP coordinates to Seurat object as a dimensionality reduction object
Macro.scanpy[["umap"]] <- CreateDimReducObject(
  embeddings = as.matrix(umap_coords),
  key = "UMAP_",
  assay = "RNA"
)
```

```{r}
# Read metadata generated by scanpy
metadata <- read.csv("/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.ST.ihn.scanpy_metadata+SNPs.csv", row.names = 1)
Macro.scanpy <- AddMetaData(Macro.scanpy, metadata)
```

```{r}
Macro.scanpy
```

```{r, fig.width=10}
# Visualize UMAP with SCANVI predictions
DimPlot(Macro.scanpy, group.by = "predictions_scanvi", label=T, repel = T) + NoLegend()
```

```{r, fig.width=10}
# Visualize UMAP split by experiment, colored by SCANVI predictions
DimPlot(Macro.scanpy, group.by = "predictions_scanvi", split.by = "STACASExperiment", ncol = 3)
```

```{r}
# Simplify cell type annotations by grouping detailed SCANVI predictions into broader categories
Macro.scanpy$STACASmacro.clusters <- plyr::revalue(as.character(Macro.scanpy$predictions_scanvi),
                                        c("FOLR2highSELENOP+ Macrophage"='Macrophages',
                                          "C1QAhighHMOX1+ Intermediate"='Macrophages',
                                          "TREM2+ Macrophage"='Macrophages',
                                          "FOLR2highLYVE1+ Macrophage"='Macrophages',
                                          "CD1c+ cDC"="DCs",
                                          "SDS+NR4A3+CXCR4+ iDC3"="DCs",
                                          "SPP1+TREM2low Macrophage"="Macrophages",
                                          "FOLR2highEGR1+ Macrophage"="Macrophages",
                                          "TNF+ICAM1+ Macrophage"="Macrophages",
                                          "FOLR2highCLEC10A+ Macrophage"="Macrophages",
                                          "CCR7+/CLEC9A+ DC1"="DCs",
                                          "ISG15+ Intermediate"="Intermediate",
                                          "CD14highS100A12+ Monocyte"="Monocyte",
                                          "CD14+FCGR3A+ Monocyte"="Monocyte",
                                          "FCGR3A+ Monocyte"="Monocyte",
                                          "SPP1+ Macrophage"="Macrophages",
                                          "CXCL10+STAT1+ Macrophage"="Macrophages",
                                          "BIRC5pos Cycling"="Macrophages"))
Idents(Macro.scanpy) <- "STACASmacro.clusters"
table(Macro.scanpy$STACASmacro.clusters, useNA = "ifany")
DimPlot(Macro.scanpy)
```

```{r}
# Save the integrated Seurat object
saveRDS(Macro.scanpy, "/datastore/Dom/Saved/2025_Mar_Organoid/Mar25.Macrophages.Organoid.inh.ST.scanpy+SNPs.rds")
```